name: "Redzone - iOS - Push to App Store"

on:
    workflow_dispatch:
        inputs:
            version:
                description: Version String
                required: true
            build:
                description: Build Number
                required: true

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  appstore:
    runs-on: 'macos-latest'
    defaults:
      run:
        working-directory: ./Redzone-iOS
    
    steps:
        - name: Checkout
          uses: actions/checkout@v4
        - name: Setup Xcode
          uses: maxim-lobanov/setup-xcode@v1.3.0
          with:
            xcode-version: ^16
        - name: Setup Homebrew
          uses: tecolicom/actions-use-homebrew-tools@v1.3
          with:
            tools: 'xcbeautify coreutils'
        - name: Setup SPM
          uses: actions/cache@v3
          with:
            path: ./Redzone-iOS/.packages
            key: ${{ runner.os }}-packages-${{ hashFiles('**/Package.resolved') }}
            restore-keys: |
              ${{ runner.os }}-packages-
        - name: Update XCConfig
          run: |
            sed -i '' 's/^VERSION=.*/VERSION=${{ github.event.inputs.version }}/' Redzone.base.xcconfig
            sed -i '' 's/^BUILD=.*/BUILD=${{ github.event.inputs.build }}/' Redzone.base.xcconfig
        - name: Resolve package dependencies
          run: set -o pipefail && stdbuf -oL xcodebuild -resolvePackageDependencies -disableAutomaticPackageResolution -clonedSourcePackagesDirPath "./.packages" | stdbuf -oL xcbeautify --renderer github-actions
        - name: Archive
          run: set -o pipefail && stdbuf -oL xcodebuild archive -scheme "Redzone" -project "Redzone.xcodeproj" -derivedDataPath "./.build" -disableAutomaticPackageResolution -clonedSourcePackagesDirPath "./.packages" -configuration release -sdk iphoneos -archivePath Redzone-iOS.xcarchive | stdbuf -oL xcbeautify --renderer github-actions
        - name: Export IPA
          run: set -o pipefail && stdbuf -oL xcodebuild -exportArchive -archivePath Redzone-iOS.xcarchive -exportOptionsPlist ./exportOptions.plist -exportPath Redzone-iOS.ipa | stdbuf -oL xcbeautify --renderer github-actions
        - name: Commit updated XCConfig
          run: |
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git add Redzone.base.xcconfig
              git commit -m "Bump Redzone iOS version to ${{ github.event.inputs.version }} (${{ github.event.inputs.build }}) [skip ci]" || echo "No changes to commit"
              git push origin main

